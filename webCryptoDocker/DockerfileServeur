# dockerfile multistage
# stage 1

FROM maven:3.5.4-jdk-8-alpine AS build

WORKDIR /myapp

COPY pom.xml .
ADD settings.xml /tmp
RUN mvn -s /tmp/settings.xml -B -e -C -T 1C org.apache.maven.plugins:maven-dependency-plugin:3.1.1:go-offline
COPY src ./src
RUN mvn -s /tmp/settings.xml -B -e -C -T 1C package


# stage 2

FROM jboss/wildfly:15.0.0.Final
COPY keycloak-wildfly-adapter-dist-6.0.1.tar.gz /tmp/keycloak-wildfly-adapter-dist.tar.gz
RUN /opt/jboss/wildfly/bin/add-user.sh admin admin --silent
ENV WILDFLY_HOME=/opt/jboss
WORKDIR /opt/jboss/wildfly/bin
COPY configCLI.txt configCLI.cli
RUN mv configCLI.cli ../configCLI.cli
# RUN ./jboss-cli.sh -c --controller=0.0.0.0 -u=admin -p=admin --file=../configCLI.cli
# RUN ./jboss-cli.sh --file=../configCLI.cli
RUN cd $WILDFLY_HOME/wildfly &&\
    tar zxvf /tmp/keycloak-wildfly-adapter-dist.tar.gz &&\
    ./bin/jboss-cli.sh --file=bin/adapter-elytron-install-offline.cli &&\
    rm -rf $WILDFLY_HOME/wildfly/standalone/configuration/standalone_xml_history
#    rm /tmp/keycloak-wildfly-adapter-dist.tar.gz
COPY standalone.xml /opt/jboss/wildfly/standalone/configuration/standalone.xml
# RUN wildfly/bin/jboss-cli.sh --command=:shutdown
# RUN pgrep -d" " -f "wildfly" | xargs kill;
# RUN ./jboss-cli.sh --file=../configCLI.cli
CMD ["/opt/jboss/wildfly/bin/standalone.sh", "-b", "0.0.0.0", "-bmanagement", "0.0.0.0"]
WORKDIR /opt/jboss/wildfly/standalone/configuration/
COPY keycloak.pem keycloak.pem
RUN keytool -importcert -keystore keycloak.jks -storepass jwtKey -file keycloak.pem -alias keycloak -trustcacerts -noprompt
COPY --from=build /myapp/target/*-withdependencies.war /opt/jboss/wildfly/standalone/deployments/server.war
